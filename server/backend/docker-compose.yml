version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: neuroglancer-backend
    ports:
      - "8000:8000"
    volumes:
      # [1] (기존) 서버 기본 저장소 (DATA_DIR)
      #     호스트의 ../appdata -> 컨테이너 /app/data/precomputed
      - ../appdata:/app/data/precomputed

      # [2] (기존) 프론트엔드 static
      - ./static:/app/static

      # 로컬 저장소 (C:\precomputed)
      #     호스트의 C:\precomputed -> 컨테이너 /app/data/precomputed/local_storage
      #     (서버 저장소의 하위 폴더로 마운트)
      - "C:/precomputed:/app/data/precomputed/local_storage"

    environment:
      #  모든 데이터의 루트 (Neuroglancer 서빙 기준)
      - DATA_DIR=/app/data/precomputed

      # 두 저장 위치의 경로를 환경 변수로 지정
      - SERVER_SAVE_PATH=/app/data/precomputed
      - LOCAL_SAVE_PATH=/app/data/precomputed/local_storage

      - PYTHONUNBUFFERED=1

    restart: unless-stopped
    # ... (이하 메모리 제한, healthcheck 등은 동일) ...
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/memory-status', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s