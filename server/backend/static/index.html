<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>Neuroglancer PNG Chunk Demo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 12px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
    }

    th {
      background: #f8f8f8;
      text-align: left;
    }

    .ok {
      color: #1a7f37;
    }

    .ng {
      color: #b42318;
    }

    .small {
      color: #666;
      font-size: 12px;
    }

    .rowok {
      background: #f6ffed;
    }

    .rowng {
      background: #fff1f0;
    }

    #controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    input[type="number"] {
      width: 90px;
    }

    .upload-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }

    .upload-section h3 {
      margin-top: 0;
      color: #495057;
    }

    .file-input {
      margin: 10px 0;
    }

    .form-group {
      margin: 15px 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #495057;
    }

    .radio-group div {
      margin-bottom: 5px;
    }
    .radio-group label {
      display: inline-block;
      margin-left: 5px;
      font-weight: normal;
    }
    .radio-group .small {
      margin-left: 20px;
      color: #6c757d;
    }

    .form-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .upload-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }

    .upload-btn:hover {
      background: #0056b3;
    }

    .upload-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .memory-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border: 1px solid #dee2e6;
    }

    .memory-controls {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    #memoryInfo div {
      margin: 5px 0;
      font-family: monospace;
    }

    .volumes-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }

    .volume-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #dee2e6;
    }

    .volume-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .volume-info {
      flex-grow: 1;
    }

    .volume-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .url-section {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border: 1px solid #e9ecef;
    }

    .url-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      background: white;
      margin: 5px 0;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 12px;
      margin: 2px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-neuroglancer {
      background: #9c27b0;
      color: white;
      font-weight: bold;
    }

    .btn:hover {
      opacity: 0.8;
    }

    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .copy-success {
      background: #d4edda !important;
      transition: background-color 0.3s;
    }
  </style>
</head>

<body>
  <h1>Neuroglancer PNG Chunk Demo</h1>
  <p class="small">
    ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì²­í¬ë¡œ ë³€í™˜ë˜ì–´ Neuroglancerì—ì„œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </p>

  <div class="upload-section">
    <h3>ğŸ“ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
    <p class="small">PNG, JPG, TIFF í˜•ì‹ì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ Neuroglancer í˜¸í™˜ ì²­í¬ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</p>

    <div class="file-input">
      <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.tiff,.tif" />
    </div>

    <div class="form-group radio-group">
      <label>ì €ì¥ ìœ„ì¹˜ ì„ íƒ:</label>
      <div>
        <input type="radio" id="saveLocal" name="save_location" value="local" checked>
        <label for="saveLocal">ë¡œì»¬ í´ë”</label>
        <div class="small">(ì„œë²„ PCì˜ <code>C:\precomputed</code>ì— ì €ì¥)</div>
      </div>
      <div>
        <input type="radio" id="saveServer" name="save_location" value="server">
        <label for="saveServer">ì„œë²„ ìŠ¤í† ë¦¬ì§€</label>
        <div class="small">(ì„œë²„ì˜ <code>appdata</code> ë³¼ë¥¨ì— ì €ì¥)</div>
      </div>
    </div>

    <div class="form-group">
      <label for="customVolumeName">ë³¼ë¥¨ ì´ë¦„ (ì„ íƒ ì‚¬í•­):</label>
      <input type="text" id="customVolumeName" class="form-input" placeholder="íŒŒì¼ ì´ë¦„ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš” (ì˜ˆ: my_volume_01)">
    </div>

    <button id="uploadBtn" class="upload-btn" disabled>ì—…ë¡œë“œ ë° ì²­í¬ ë³€í™˜</button>

    <div id="uploadStatus"></div>
  </div>

  <div class="memory-section">
    <h3>ğŸ§  ë©”ëª¨ë¦¬ ìƒíƒœ</h3>
    <div id="memoryInfo">
      <div>ì„œë²„ ë©”ëª¨ë¦¬: <span id="serverMemory">ë¡œë”© ì¤‘...</span></div>
      <div>ìºì‹œ ì‚¬ìš©ëŸ‰: <span id="cacheUsage">ë¡œë”© ì¤‘...</span></div>
      <div>ì²˜ë¦¬ íš¨ìœ¨ì„±: <span id="cacheHitRate">ë¡œë”© ì¤‘...</span></div>
    </div>
    <div class="memory-controls">
      <button onclick="refreshMemoryStats()" class="btn btn-primary">ìƒˆë¡œê³ ì¹¨</button>
      <button onclick="cleanupMemory()" class="btn btn-success">ë©”ëª¨ë¦¬ ì •ë¦¬</button>
    </div>
  </div>

  <div class="volumes-section">
    <h3>ğŸ“Š ë³€í™˜ëœ ë³¼ë¥¨ ëª©ë¡</h3>
    <p class="small">ì—…ë¡œë“œí•˜ì—¬ ë³€í™˜ëœ ì´ë¯¸ì§€ë“¤ì„ Neuroglancerì—ì„œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <button id="refreshBtn" class="btn btn-primary">ìƒˆë¡œê³ ì¹¨</button>
    <div id="volumesList"></div>
  </div>

  <div class="volumes-section">
    <h3>ğŸ§ª íƒ€ì¼ í…ŒìŠ¤íŠ¸</h3>
    <p class="small">ë³€í™˜ëœ ë³¼ë¥¨ì˜ ê°œë³„ íƒ€ì¼ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

    <div id="controls">
      <label>ë³¼ë¥¨ ì„ íƒ:
        <select id="volumeSelect">
          <option value="">ë³¼ë¥¨ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </label>
      <label>Level key:
        <input id="level" type="text" value="0" />
      </label>
      <label>Fetch count (tiles):
        <input id="count" type="number" value="8" min="1" />
      </label>
      <button id="startBtn" class="btn btn-primary">Fetch tiles</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>URL</th>
          <th>Status</th>
          <th>Bytes</th>
          <th>Time (ms)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script>
    // íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const refreshBtn = document.getElementById('refreshBtn');
    const volumesList = document.getElementById('volumesList');
    const volumeSelect = document.getElementById('volumeSelect');

    // ê²½ë¡œ ì„¤ì • ê´€ë ¨ UI ì œê±°
    // const defaultOutputPathInput = ...
    // const setDefaultPathBtn = ...
    // const defaultPathStatus = ...
    // const currentDefaultPathEl = ...

    // íŒŒì¼ ì„ íƒ ì‹œ ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
    fileInput.addEventListener('change', () => {
      uploadBtn.disabled = !fileInput.files.length;
    });

    // íŒŒì¼ ì—…ë¡œë“œ
    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      // ì˜µì…˜ ê°’ ì½ê¸°
      const saveLocation = document.querySelector('input[name="save_location"]:checked').value;
      const volumeName = document.getElementById('customVolumeName').value;

      uploadBtn.disabled = true;
      uploadStatus.innerHTML = '<div class="status info">ì—…ë¡œë“œ ì¤‘...</div>';

      const formData = new FormData();
      formData.append('file', file);

      // í¼ ë°ì´í„°ì— ì˜µì…˜ ì¶”ê°€
      formData.append('save_location', saveLocation);
      if (volumeName) {
        formData.append('volume_name', volumeName);
      }

      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          uploadStatus.innerHTML = `<div class="status success">${result.message}</div>`;
          fileInput.value = '';
          document.getElementById('customVolumeName').value = ''; // í•„ë“œ ì´ˆê¸°í™”
          uploadBtn.disabled = true;
          loadVolumes();
          refreshMemoryStats();
        } else {
          uploadStatus.innerHTML = `<div class="status error">ì—ëŸ¬: ${result.detail}</div>`;
        }
      } catch (error) {
        uploadStatus.innerHTML = `<div class="status error">ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
      } finally {
        uploadBtn.disabled = false;
      }
    });

    // ê¸°ë³¸ ê²½ë¡œ ë¡œë“œ í•¨ìˆ˜ ì œê±°
    // async function loadCurrentDefaultPath() { ... }
    // ê¸°ë³¸ ê²½ë¡œ ì„¤ì • í•¨ìˆ˜ ì œê±°
    // setDefaultPathBtn.addEventListener('click', ...);

    // ë©”ëª¨ë¦¬ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
    async function refreshMemoryStats() {
      try {
        const response = await fetch('/api/memory-status');
        if (!response.ok) { throw new Error('Memory API not found or failed'); }
        const stats = await response.json();

        document.getElementById('serverMemory').textContent =
          `${stats.memory.process_mb.toFixed(1)}MB (${stats.memory.system_percent.toFixed(1)}%)`;
        document.getElementById('cacheUsage').textContent =
          `${stats.cache.cache_size_mb.toFixed(1)}MB / ${stats.config.cache_max_size_mb}MB`;
        document.getElementById('cacheHitRate').textContent =
          `${(stats.cache.hit_rate * 100).toFixed(1)}%`;

      } catch (error) {
        console.warn('ë©”ëª¨ë¦¬ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', error.message);
        document.getElementById('memoryInfo').innerHTML = `<p class='small ng'>ë©”ëª¨ë¦¬ ìƒíƒœë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
      }
    }

    // ë©”ëª¨ë¦¬ ì •ë¦¬
    async function cleanupMemory() {
      try {
        const response = await fetch('/api/memory-cleanup', { method: 'POST' });
        if (!response.ok) { throw new Error('Memory API not found or failed'); }
        const result = await response.json();

        alert(`ë©”ëª¨ë¦¬ ì •ë¦¬ ì™„ë£Œ: ${result.freed_mb.toFixed(1)}MB í•´ì œ`);
        refreshMemoryStats();

      } catch (error) {
        alert('ë©”ëª¨ë¦¬ ì •ë¦¬ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // URL ë³µì‚¬ ê¸°ëŠ¥
    function copyToClipboard(text, buttonElement) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = buttonElement.textContent;
        const originalClass = buttonElement.className;
        buttonElement.textContent = 'ë³µì‚¬ë¨!';
        buttonElement.classList.add('copy-success');
        setTimeout(() => {
          buttonElement.textContent = originalText;
          buttonElement.className = originalClass;
        }, 2000);
      }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        alert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ (í´ë¦½ë³´ë“œ ì ‘ê·¼ ì‹¤íŒ¨ë¡œ ì¸í•œ í´ë°±).');
      });
    }

    // Neuroglancer ì—´ê¸° (ìˆ˜ì • ë¶ˆí•„ìš”)
    function openNeuroglancer(sourceUrl, volumeName) {
      const neuroglancerConfig = {
        "layers": [
          { "type": "image", "source": sourceUrl, "name": volumeName, "blend": "default" }
        ],
        "navigation": { "pose": { "position": { "voxelSize": [1, 1, 1] } }, "zoomFactor": 8 },
        "showSlices": false, "layout": "4panel"
      };
      const configString = JSON.stringify(neuroglancerConfig);
      const encodedConfig = encodeURIComponent(configString);
      const neuroglancerUrl = `https://neuroglancer-demo.appspot.com/#!${encodedConfig}`;
      window.open(neuroglancerUrl, '_blank');
    }

    // ë³¼ë¥¨ ëª©ë¡ ë¡œë“œ
    async function loadVolumes() {
      try {
        const response = await fetch('/api/volumes');
        const result = await response.json();
        if (response.ok) {
          displayVolumes(result.volumes);
          updateVolumeSelect(result.volumes);
        }
      } catch (error)
      {
        console.error('ë³¼ë¥¨ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ë³¼ë¥¨ ëª©ë¡ í‘œì‹œ
    function displayVolumes(volumes) {
    if (volumes.length === 0) {
        volumesList.innerHTML = '<p class="small">ì•„ì§ ë³€í™˜ëœ ë³¼ë¥¨ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ë³´ì„¸ìš”!</p>';
        return;
    }

    const currentHost = `${window.location.protocol}//${window.location.host}`;

    volumesList.innerHTML = volumes.map(volume => {
        // ğŸ”¥ ìˆ˜ì •: HTTP í”„ë¡œí† ì½œ í¬í•¨
        const sourceUrl = `precomputed://${currentHost}${volume.path}`;

        // ë°±ì—”ë“œì—ì„œ ìƒì„±ëœ Neuroglancer URL (ì´ë¯¸ ì˜¬ë°”ë¥¸ í˜•ì‹)
        const neuroglancerUrl = volume.neuroglancer_url.replace("http://localhost:8000", currentHost);

        return `
          <div class="volume-item">
            <div class="volume-header">
              <div class="volume-info">
                <strong>ğŸ“Š ${volume.name}</strong>
                <br>
                <span class="small">ì €ì¥ ìœ„ì¹˜: <code>${volume.local_path}</code></span>
              </div>
            </div>

            <div class="url-section">
              <strong>Precomputed ì†ŒìŠ¤ URL:</strong>
              <input type="text" class="url-input" value="${sourceUrl}" readonly>
              <button onclick="copyToClipboard('${sourceUrl}', this)" class="btn btn-warning">
                ğŸ“‹ ì†ŒìŠ¤ URL ë³µì‚¬
              </button>
            </div>

            <div class="url-section">
              <strong>Neuroglancer ì§ì ‘ ë§í¬:</strong>
              <input type="text" class="url-input" value="${neuroglancerUrl}" readonly>
              <button onclick="copyToClipboard('${neuroglancerUrl}', this)" class="btn btn-info">
                ğŸ”— Neuroglancer URL ë³µì‚¬
              </button>
            </div>

            <div class="volume-actions">
              <button onclick="window.open('${neuroglancerUrl}', '_blank')" class="btn btn-neuroglancer">
                ğŸ§  Neuroglancerì—ì„œ ì—´ê¸°
              </button>
              <a href="${volume.info_url}" target="_blank" class="btn btn-primary">ğŸ“‹ Info ë³´ê¸°</a>
              <button onclick="deleteVolume('${volume.name}')" class="btn btn-danger">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
          </div>
        `;
        }).join('');
    }

    // ë³¼ë¥¨ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    function updateVolumeSelect(volumes) {
      volumeSelect.innerHTML = '<option value="">ë³¼ë¥¨ì„ ì„ íƒí•˜ì„¸ìš”</option>' +
        volumes.map(volume => `<option value="${volume.name}">${volume.name} (${volume.path})</option>`).join('');
    }

    // ë³¼ë¥¨ ì‚­ì œ
    async function deleteVolume(volumeName) {
      if (!confirm(`ë³¼ë¥¨ '${volumeName}'ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        const response = await fetch(`/api/volumes/${volumeName}`, {
          method: 'DELETE'
        });
        const result = await response.json();
        if (response.ok) {
          alert(result.message);
          loadVolumes();
        } else {
          alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.detail}`);
        }
      } catch (error) {
        alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
    refreshBtn.addEventListener('click', loadVolumes);

    // íƒ€ì¼ í…ŒìŠ¤íŠ¸ ê´€ë ¨ ì½”ë“œ
    let volumeInfo = null;

    // [â­ï¸ ìˆ˜ì •] ë³¼ë¥¨ info ë¡œë“œ (ì´ì œ /precomp/ ê²½ë¡œê°€ ë™ì ì„)
    async function loadVolumeInfo(volumeName) {
      // volumeSelect.valueê°€ ì•„ë‹Œ, ì „ì²´ ë³¼ë¥¨ ëª©ë¡ì—ì„œ ê²½ë¡œë¥¼ ì°¾ì•„ì•¼ í•¨
      const response = await fetch('/api/volumes');
      const result = await response.json();
      const volume = result.volumes.find(v => v.name === volumeName);

      if (!volume) {
          console.error('ë³¼ë¥¨ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return null;
      }

      const infoUrl = volume.info_url; // ì˜ˆ: /precomp/local_storage/my_volume/info

      try {
        const response = await fetch(infoUrl);
        if (response.ok) {
          volumeInfo = await response.json();
          // ë³¼ë¥¨ infoì— URL ê²½ë¡œ ì €ì¥
          volumeInfo.basePath = volume.path;
          return volumeInfo;
        }
      } catch (error) {
        console.error('ë³¼ë¥¨ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
      return null;
    }

    // íƒ€ì¼ URL íŒ¨í„´ (ë™ì  ê²½ë¡œ ì ìš©)
    const TILE_PATTERN = (basePath, lvlKey, xStart, xEnd, yStart, yEnd, zStart = 0, zEnd = 1) => {
      // basePath ì˜ˆ: /precomp/local_storage/my_volume
      return `${basePath}/${lvlKey}/${xStart}-${xEnd}_${yStart}-${yEnd}_${zStart}-${zEnd}`;
    };

    async function fetchTile(url, idx) {
      const t0 = performance.now();
      try {
        const resp = await fetch(url);
        const buf = await resp.arrayBuffer();
        const t1 = performance.now();
        return { ok: resp.ok, status: resp.status, bytes: buf.byteLength, ms: Math.round(t1 - t0), url, idx };
      } catch (e) {
        const t1 = performance.now();
        return { ok: false, status: "ERR", bytes: 0, ms: Math.round(t1 - t0), url, idx };
      }
    }

    function renderRow(res) {
      const tr = document.createElement("tr");
      tr.className = res.ok ? "rowok" : "rowng";
      tr.innerHTML = `
        <td>${res.idx + 1}</td>
        <td class="small"><code>${res.url}</code></td>
        <td>${res.ok ? `<span class="ok">${res.status}</span>` : `<span class="ng">${res.status}</span>`}</td>
        <td>${res.bytes}</td>
        <td>${res.ms}</td>
      `;
      document.getElementById("tbody").appendChild(tr);
    }

    // íƒ€ì¼ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìƒˆë¡œìš´ URL íŒ¨í„´ ì ìš©)
    document.getElementById("startBtn").addEventListener("click", async () => {
      const volume = volumeSelect.value;
      if (!volume) {
        alert('ë³¼ë¥¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const info = await loadVolumeInfo(volume);
      if (!info) {
        alert('ë³¼ë¥¨ info íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const levelKey = document.getElementById("level").value.trim();
      const count = parseInt(document.getElementById("count").value, 10);
      document.getElementById("tbody").innerHTML = "";

      let chunkSizeX, chunkSizeY;
      try {
        chunkSizeX = info.scales[0].chunk_sizes[0][0];
        chunkSizeY = info.scales[0].chunk_sizes[0][1];
      } catch (e) {
        alert('info íŒŒì¼ì—ì„œ ì²­í¬ í¬ê¸°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const tasks = [];
      let x0 = 0, y0 = 0;
      for (let i = 0; i < count; i++) {
        let x1 = x0 + chunkSizeX;
        let y1 = y0 + chunkSizeY;

        // infoì— ì €ì¥ëœ basePath ì‚¬ìš©
        const url = TILE_PATTERN(info.basePath, levelKey, x0, x1, y0, y1, 0, 1);
        tasks.push(fetchTile(url, i));

        x0 += chunkSizeX;
        if (i % 4 === 3) {
          x0 = 0;
          y0 += chunkSizeY;
        }
      }

      const results = await Promise.all(tasks);
      results.forEach(renderRow);
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë³¼ë¥¨ ëª©ë¡ ë° ìƒíƒœ ë¡œë“œ
    // loadCurrentDefaultPath(); ì œê±°
    loadVolumes();
    refreshMemoryStats();

    // 5ì´ˆë§ˆë‹¤ ë©”ëª¨ë¦¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    setInterval(refreshMemoryStats, 5000);
  </script>
</body>

</html>