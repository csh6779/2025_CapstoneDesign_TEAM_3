<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuroglancer ì²­í¬ ìˆ˜ì • ë„êµ¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .volume-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .volume-name {
            font-weight: bold;
            color: #333;
        }
        .volume-url {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.warning {
            background: #ffc107;
            color: #333;
        }
        button.warning:hover {
            background: #e0a800;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Neuroglancer ì²­í¬ ìˆ˜ì • ë„êµ¬</h1>
        
        <div class="section">
            <h2>ğŸ“Š ì„œë²„ ìƒíƒœ</h2>
            <p>API ì„œë²„: <span id="serverStatus">í™•ì¸ ì¤‘...</span></p>
            <button onclick="checkServerStatus()">ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="section">
            <h2>ğŸ“ ë³¼ë¥¨ ëª©ë¡</h2>
            <button onclick="loadVolumes()">ë³¼ë¥¨ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            <div id="volumesList">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="section">
            <h2>ğŸ“ ì‘ì—… ë¡œê·¸</h2>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            <div id="log" class="log">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...\n</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let logElement = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${prefix} ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            logElement.innerHTML = 'ë¡œê·¸ ì´ˆê¸°í™”ë¨\n';
        }

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/memory-status`);
                if (response.ok) {
                    const status = await response.json();
                    document.getElementById('serverStatus').innerHTML = 
                        `<span class="status-indicator status-ok"></span>ì •ìƒ ë™ì‘ ì¤‘ (ë©”ëª¨ë¦¬: ${status.memory_usage_percent.toFixed(1)}%)`;
                    log('ì„œë²„ ìƒíƒœ í™•ì¸ ì™„ë£Œ', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('serverStatus').innerHTML = 
                    `<span class="status-indicator status-error"></span>ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
                log(`ì„œë²„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function loadVolumes() {
            const volumesContainer = document.getElementById('volumesList');
            volumesContainer.innerHTML = 'ë¡œë”© ì¤‘...';
            
            try {
                log('ë³¼ë¥¨ ëª©ë¡ ë¡œë“œ ì¤‘...');
                const response = await fetch(`${API_BASE}/volumes`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.volumes.length === 0) {
                    volumesContainer.innerHTML = '<p>ë³¼ë¥¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    log('ë³¼ë¥¨ì´ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                volumesContainer.innerHTML = '';
                data.volumes.forEach(volume => {
                    const volumeDiv = document.createElement('div');
                    volumeDiv.className = 'volume-item';
                    
                    volumeDiv.innerHTML = `
                        <div>
                            <div class="volume-name">${volume.name}</div>
                            <div class="volume-url">${volume.neuroglancer_url}</div>
                        </div>
                        <div>
                            <button class="warning" onclick="fixChunks('${volume.name}')">ì²­í¬ ìˆ˜ì •</button>
                            <button onclick="testVolume('${volume.name}')">í…ŒìŠ¤íŠ¸</button>
                            <button class="danger" onclick="deleteVolume('${volume.name}')">ì‚­ì œ</button>
                        </div>
                    `;
                    
                    volumesContainer.appendChild(volumeDiv);
                });
                
                log(`${data.volumes.length}ê°œ ë³¼ë¥¨ ë¡œë“œ ì™„ë£Œ`, 'success');
                
            } catch (error) {
                volumesContainer.innerHTML = `<p class="error">ë³¼ë¥¨ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</p>`;
                log(`ë³¼ë¥¨ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function fixChunks(volumeName) {
            if (!confirm(`ë³¼ë¥¨ "${volumeName}"ì˜ ì²­í¬ë¥¼ Neuroglancer í˜•ì‹ìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            const button = event.target;
            button.disabled = true;
            button.textContent = 'ìˆ˜ì • ì¤‘...';

            try {
                log(`ë³¼ë¥¨ "${volumeName}" ì²­í¬ ìˆ˜ì • ì‹œì‘...`);
                
                const response = await fetch(`${API_BASE}/volumes/${encodeURIComponent(volumeName)}/fix-chunks`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                
                log(`ì²­í¬ ìˆ˜ì • ì™„ë£Œ: ${result.fixed_chunks}ê°œ ë³€í™˜`, 'success');
                
                if (result.errors.length > 0) {
                    log(`ì˜¤ë¥˜ ë°œìƒ: ${result.errors.join(', ')}`, 'error');
                }

                // ë³¼ë¥¨ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(loadVolumes, 1000);

            } catch (error) {
                log(`ì²­í¬ ìˆ˜ì • ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'ì²­í¬ ìˆ˜ì •';
            }
        }

        async function testVolume(volumeName) {
            try {
                log(`ë³¼ë¥¨ "${volumeName}" í…ŒìŠ¤íŠ¸ ì¤‘...`);
                
                // info íŒŒì¼ í…ŒìŠ¤íŠ¸
                const infoUrl = `http://localhost:8000/precomp/${encodeURIComponent(volumeName)}/info`;
                const infoResponse = await fetch(infoUrl);
                
                if (infoResponse.ok) {
                    log(`âœ… info íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥: ${infoUrl}`, 'success');
                    
                    // Neuroglancer URL ìƒì„±
                    const neuroglancerUrl = `https://neuroglancer-demo.appspot.com/#!{'layers':{'image':{'type':'image','source':'precomputed://http://localhost:8000/precomp/${encodeURIComponent(volumeName)}'}}}`;
                    
                    log(`ğŸš€ Neuroglancer URL: ${neuroglancerUrl}`);
                    
                    if (confirm('Neuroglancerì—ì„œ ë³¼ë¥¨ì„ ì—´ì–´ë³´ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        window.open(neuroglancerUrl, '_blank');
                    }
                } else {
                    log(`âŒ info íŒŒì¼ ì ‘ê·¼ ì‹¤íŒ¨: HTTP ${infoResponse.status}`, 'error');
                }
                
            } catch (error) {
                log(`ë³¼ë¥¨ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function deleteVolume(volumeName) {
            if (!confirm(`ë³¼ë¥¨ "${volumeName}"ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            try {
                log(`ë³¼ë¥¨ "${volumeName}" ì‚­ì œ ì¤‘...`);
                
                const response = await fetch(`${API_BASE}/volumes/${encodeURIComponent(volumeName)}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                log(result.message, 'success');

                // ë³¼ë¥¨ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadVolumes();

            } catch (error) {
                log(`ë³¼ë¥¨ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            checkServerStatus();
            loadVolumes();
        };
    </script>
</body>
</html>