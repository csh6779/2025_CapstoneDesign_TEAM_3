<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OSD + Zarr/DZI Viewer</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    #osd {
      width: 100%;
      height: 100vh;
      background: #111;
    }

    .toolbar {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.95);
      padding: 6px 10px;
      border-radius: 8px;
      font-family: sans-serif;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .toolbar input[type="file"] {
      max-width: 220px;
    }
  </style>
  <script src="https://unpkg.com/openseadragon@4.1.0/build/openseadragon/openseadragon.min.js"></script>
</head>

<body>
  <div class="toolbar">
    <b>Source</b>:
    <select id="source">
      <option value="zarr">zarr</option>
      <option value="dzi">dzi</option>
    </select>
    <input id="imageId" placeholder="image id (e.g., wafer)" />
    <button id="loadBtn">Load</button>
    <input id="uploader" type="file" accept=".tif,.tiff,.bmp,.png,.jpg,.jpeg" />
    <button id="uploadBtn">Upload→Ingest</button>
    <label><input type="checkbox" id="createDzi" checked> Create DZI</label>
    <span id="status" style="font-size:12px;color:#333"></span>
    <span id="dziStatus" style="font-size:11px;color:#666;margin-left:10px;"></span>
  </div>
  <div id="osd"></div>
  <script>
    function qs(name) {
      const p = new URLSearchParams(location.search); return p.get(name);
    }
    const idInput = document.getElementById('imageId');
    const srcSel = document.getElementById('source');
    const loadBtn = document.getElementById('loadBtn');
    const uploader = document.getElementById('uploader');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusEl = document.getElementById('status');

    // 쿼리 파라미터로 초기화
    const qSource = qs('source') || 'zarr';
    const qId = qs('id') || '';  // 기본값을 빈 문자열로 변경
    srcSel.value = qSource;
    idInput.value = qId;

    // DZI 상태 확인 및 표시 (ID가 있을 때만)
    async function checkDziStatus(id) {
      if (!id) return false;
      try {
        const response = await fetch(`/dzi/${id}.dzi`);
        if (response.ok) {
          document.getElementById('dziStatus').textContent = '✓ DZI available';
          document.getElementById('dziStatus').style.color = '#28a745';
          return true;
        } else {
          document.getElementById('dziStatus').textContent = '✗ DZI not found';
          document.getElementById('dziStatus').style.color = '#dc3545';
          return false;
        }
      } catch (err) {
        document.getElementById('dziStatus').textContent = '✗ DZI check failed';
        document.getElementById('dziStatus').style.color = '#dc3545';
        return false;
      }
    }

    // 페이지 로드 시 DZI 상태 확인 (ID가 있을 때만)
    if (qId) {
      checkDziStatus(qId);
    } else {
      // ID가 없으면 상태 메시지 초기화
      document.getElementById('dziStatus').textContent = 'ID를 입력하고 Load를 클릭하세요';
      document.getElementById('dziStatus').style.color = '#666';
    }

    let viewer = OpenSeadragon({
      id: 'osd',
      prefixUrl: 'https://unpkg.com/openseadragon@4.1.0/build/openseadragon/images/',
      showNavigator: true,
      visibilityRatio: 1.0,
      minZoomImageRatio: 0.5,
      maxZoomPixelRatio: 2.5,
      animationTime: 0.8,
    });

    async function loadZarr(id) {
      try {
        const response = await fetch(`/zarr/${id}/meta`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const meta = await response.json();

        const ts = {
          width: meta.width,
          height: meta.height,
          tileSize: meta.tileSize,
          tileOverlap: meta.tileOverlap,
          minLevel: meta.minLevel,
          maxLevel: meta.maxLevel,
          getTileUrl: function (level, x, y) {
            return `/zarr/${id}/tile/${level}/${x}/${y}.jpg`;
          }
        };
        viewer.open(ts);
      } catch (error) {
        alert(`Zarr 로드 실패: ${error.message}`);
        throw new Error(`Zarr 로드 실패: ${error.message}`);
      }
    }

    async function loadDzi(id) {
      try {
        await viewer.open(`/dzi/${id}.dzi`);
      } catch (error) {
        alert(`DZI 로드 실패: ${error.message}`);
        throw new Error(`DZI 로드 실패: ${error.message}`);
      }
    }

    async function doLoad() {
      const id = idInput.value.trim();
      const src = srcSel.value;
      if (!id) {
        statusEl.textContent = 'ID를 입력하고 Load를 클릭하세요';
        document.getElementById('dziStatus').textContent = 'ID를 입력하고 Load를 클릭하세요';
        document.getElementById('dziStatus').style.color = '#666';
        return;
      }

      statusEl.textContent = '로딩 중...';

      try {
        // DZI 상태 업데이트
        await checkDziStatus(id);

        if (src === 'zarr') {
          await loadZarr(id);
          statusEl.textContent = `Zarr 로드 완료: ${id}`;
        } else {
          const dziExists = await checkDziStatus(id);
          if (!dziExists) {
            statusEl.textContent = `DZI가 존재하지 않습니다: ${id}`;
            return;
          }

          await loadDzi(id);
          statusEl.textContent = `DZI 로드 완료: ${id}`;
        }
      } catch (error) {
        console.error('로드 실패:', error);
        statusEl.textContent = `로드 실패: ${error.message}`;
        // 오류창 대신 상태 메시지만 표시
      }
    }

    async function doUpload() {
      const f = uploader.files[0];
      if (!f) return alert('파일을 선택하세요');
      const defaultId = f.name.replace(/\.[^.]+$/, '');
      const imageId = prompt('image_id (영문/숫자/언더스코어/대시)', defaultId) || defaultId;
      const createDzi = document.getElementById('createDzi').checked;

      const fd = new FormData();
      fd.append('file', f, f.name);
      fd.append('image_id', imageId);
      fd.append('ingest', 'true');
      fd.append('create_dzi', createDzi);

      statusEl.textContent = '업로드 중...';
      uploadBtn.disabled = true;

      try {
        const r = await fetch('/upload', { method: 'POST', body: fd });
        if (!r.ok) {
          const msg = await r.text();
          throw new Error(msg);
        }
        const res = await r.json();

        let statusMsg = '완료: ' + res.image_id;
        if (res.file_size_mb) {
          statusMsg += ` [${res.file_size_mb}MB]`;
        }
        if (res.dzi) {
          statusMsg += ` (Zarr + DZI 생성됨)`;
          // DZI가 생성되었으면 DZI 소스로 자동 전환
          srcSel.value = 'dzi';
          document.getElementById('dziStatus').textContent = '✓ DZI created';
          document.getElementById('dziStatus').style.color = '#28a745';
        } else if (res.dzi_warning) {
          statusMsg += ` (Zarr만 생성됨, DZI 실패: ${res.dzi_warning})`;
          document.getElementById('dziStatus').textContent = '✗ DZI failed';
          document.getElementById('dziStatus').style.color = '#dc3545';
        } else if (res.dzi_skipped) {
          statusMsg += ` (Zarr만 생성됨, ${res.dzi_skipped})`;
          document.getElementById('dziStatus').textContent = '⚠ DZI skipped';
          document.getElementById('dziStatus').style.color = '#ffc107';
        }

        statusEl.textContent = statusMsg;
        idInput.value = res.image_id;
        await doLoad();
      } catch (err) {
        console.error(err);
        statusEl.textContent = '실패: ' + err;
        alert('업로드 실패: ' + err);
      } finally {
        uploadBtn.disabled = false;
      }
    }

    loadBtn.addEventListener('click', doLoad);
    uploadBtn.addEventListener('click', doUpload);
    doLoad();
  </script>
</body>

</html>